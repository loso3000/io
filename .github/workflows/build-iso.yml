name: build-iso

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

env:
  BUILD_DIR: /tmp/iso_build
  OUTPUT_DIR: ${{ github.workspace }}/output

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xorriso \
          grub2-common \
          grub-pc-bin \
          grub-efi-amd64-bin \
          wget \
          mtools \
          dosfstools
        
    - name: Make scripts executable
      run: |
        chmod +x scripts/*.sh
        chmod +x scripts/lib/*.sh
        
    - name: Build ISO
      run: |
        # 设置环境变量
        export BUILD_DIR="/tmp/iso_build_${{ github.run_id }}"
        export OUTPUT_DIR="${{ github.workspace }}/output"
        
        # 创建输出目录
        mkdir -p "$OUTPUT_DIR"
        
        # 运行构建脚本
        ./scripts/build-live-iso.sh
        
        # 检查结果
        echo "=== 构建结果 ==="
        find "$OUTPUT_DIR" -name "*.iso" -type f | xargs ls -lh
        
    - name: List output files
      run: |
        echo "=== 输出目录内容 ==="
        ls -la output/ || echo "输出目录不存在"
        
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: minimal-live-iso
        path: output/*.iso
        if-no-files-found: error
        retention-days: 7
        
    - name: Quick test with QEMU
      if: success()
      run: |
        # 安装QEMU用于快速测试
        sudo apt-get install -y qemu-system-x86
        
        # 查找最新的ISO
        LATEST_ISO=$(ls -t output/*.iso 2>/dev/null | head -1)
        
        if [ -n "$LATEST_ISO" ] && [ -f "$LATEST_ISO" ]; then
            echo "=== 快速测试 ==="
            echo "测试文件: $(basename "$LATEST_ISO")"
            
            # 短暂测试引导过程
            timeout 3 qemu-system-x86_64 \
                -cdrom "$LATEST_ISO" \
                -m 256 \
                -boot d \
                -serial stdio \
                -display none \
                2>&1 | grep -i -E "(booting|loading|kernel)" | head -5 || true
        else
            echo "错误: 找不到ISO文件进行测试"
        fi
